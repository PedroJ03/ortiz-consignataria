{% extends "base.html" %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

    <div class="lg:col-span-3 space-y-6">
        
        <div class="bg-white p-1 rounded-lg border border-gray-200 flex shadow-sm">
            <button id="btn-faena" onclick="cambiarModo('faena')" class="flex-1 py-2 rounded font-semibold text-sm transition-all">
                Faena (MAG)
            </button>
            <button id="btn-invernada" onclick="cambiarModo('invernada')" class="flex-1 py-2 rounded font-semibold text-sm transition-all">
                Invernada
            </button>
        </div>

        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-5">
            <h3 class="text-brand font-bold text-xs uppercase tracking-wider mb-4 border-b pb-2">Filtros de Búsqueda</h3>
            
            <form id="filter-form" class="space-y-4">
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Desde</label>
                        <input type="text" id="date-start" class="w-full bg-gray-50 border border-gray-300 text-gray-800 text-sm rounded px-2 py-2 focus:ring-1 focus:ring-brand focus:border-brand outline-none font-medium">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Hasta</label>
                        <input type="text" id="date-end" class="w-full bg-gray-50 border border-gray-300 text-gray-800 text-sm rounded px-2 py-2 focus:ring-1 focus:ring-brand focus:border-brand outline-none font-medium">
                    </div>
                </div>

                <hr class="border-gray-100">

                <div id="container-subtipo-invernada" class="hidden">
                    <label class="block text-xs font-bold text-gray-500 mb-2">Tipo Hacienda</label>
                    <div class="grid grid-cols-3 gap-1">
                        <button type="button" onclick="filtrarCategoriasInvernada('Macho')" class="btn-subtipo px-2 py-1 text-xs border rounded hover:bg-gray-50 transition-colors">Machos</button>
                        <button type="button" onclick="filtrarCategoriasInvernada('Hembra')" class="btn-subtipo px-2 py-1 text-xs border rounded hover:bg-gray-50 transition-colors">Hembras</button>
                        <button type="button" onclick="filtrarCategoriasInvernada('Vientre')" class="btn-subtipo px-2 py-1 text-xs border rounded hover:bg-gray-50 transition-colors">Vientres</button>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Categoría</label>
                    <select id="categoria" class="w-full bg-white border border-gray-300 text-gray-800 text-sm rounded p-2 focus:border-brand outline-none">
                        <option>Cargando...</option>
                    </select>
                </div>

                <div id="container-raza">
                    <label class="block text-xs font-bold text-gray-500 mb-1">Raza / Calidad</label>
                    <select id="raza" class="w-full bg-white border border-gray-300 text-gray-800 text-sm rounded p-2 focus:border-brand outline-none disabled:bg-gray-50 disabled:text-gray-400" disabled>
                        <option value="">-</option>
                    </select>
                </div>

                <div id="container-peso">
                    <label class="block text-xs font-bold text-gray-500 mb-1">Peso</label>
                    <select id="peso" class="w-full bg-white border border-gray-300 text-gray-800 text-sm rounded p-2 focus:border-brand outline-none disabled:bg-gray-50 disabled:text-gray-400" disabled>
                        <option value="">-</option>
                    </select>
                </div>

                <button type="button" id="btn-actualizar" class="w-full mt-4 bg-brand hover:bg-brand-light text-white font-bold py-3 rounded shadow transition-colors text-sm uppercase tracking-wide">
                    Actualizar Gráfica
                </button>
            </form>
        </div>
    </div>

    <div class="lg:col-span-9 space-y-6">
        
        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 h-[600px] relative flex flex-col">
            
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-xl font-bold text-brand brand-font">Evolución de Mercado</h2>
                    <p class="text-xs text-gray-400 font-medium">Relación Precio vs. Volumen Operado</p>
                </div>
                
                <div class="flex items-center gap-2 bg-gray-50 p-1 rounded border border-gray-200">
                    <label class="text-xs font-bold text-gray-500 pl-2">Agrupar:</label>
                    <select id="agrupacion-selector" class="bg-transparent text-xs font-bold text-brand outline-none cursor-pointer">
                        <option value="auto" selected>Automática</option>
                        <option value="diario">Diaria</option>
                        <option value="semanal">Semanal</option>
                        <option value="mensual">Mensual</option>
                    </select>
                </div>
            </div>
            
            <div class="relative flex-grow w-full">
                <canvas id="mainChart"></canvas>
                <div id="loading-spinner" class="absolute inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-10 hidden">
                    <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-brand"></div>
                    <p class="mt-3 text-xs text-gray-500 font-semibold">Procesando datos...</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
             <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex items-center justify-between">
                <div>
                    <p class="text-xs font-bold text-gray-400 uppercase">Precio Máximo (Período)</p>
                    <p class="text-2xl font-bold text-brand mt-1" id="kpi-maximo">--</p>
                </div>
                <div class="bg-blue-50 p-2 rounded-full text-brand opacity-50">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                </div>
             </div>
             <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex items-center justify-between">
                <div>
                    <p class="text-xs font-bold text-gray-400 uppercase">Volumen Total (Cabezas)</p>
                    <p class="text-2xl font-bold text-brand mt-1" id="kpi-cabezas">--</p>
                </div>
                <div class="bg-gray-100 p-2 rounded-full text-gray-500 opacity-50">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                </div>
             </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts_extra %}
<script>
    // --- ESTADO GLOBAL ---
    let currentMode = 'faena';
    let chartInstance = null;
    let allInvernadaCategories = [];

    // Configurar Flatpickr
    const commonConfig = { dateFormat: "d/m/Y", locale: "es", disableMobile: "true" };
    const startDefault = new Date(); startDefault.setMonth(startDefault.getMonth() - 6); // Default 6 meses
    const fpStart = flatpickr("#date-start", { ...commonConfig, defaultDate: startDefault });
    const fpEnd = flatpickr("#date-end", { ...commonConfig, defaultDate: new Date() });

    // --- UI & MODOS ---
    function cambiarModo(modo) {
        currentMode = modo;
        const btnFaena = document.getElementById('btn-faena');
        const btnInvernada = document.getElementById('btn-invernada');
        
        const activeClass = "bg-brand text-white shadow";
        const inactiveClass = "bg-white text-gray-500 hover:bg-gray-50";

        if (modo === 'faena') {
            btnFaena.className = `flex-1 py-2 rounded font-semibold text-sm transition-all ${activeClass}`;
            btnInvernada.className = `flex-1 py-2 rounded font-semibold text-sm transition-all ${inactiveClass}`;
            
            document.getElementById('container-raza').classList.remove('hidden');
            document.getElementById('container-peso').classList.remove('hidden');
            document.getElementById('container-subtipo-invernada').classList.add('hidden');
        } else {
            btnInvernada.className = `flex-1 py-2 rounded font-semibold text-sm transition-all ${activeClass}`;
            btnFaena.className = `flex-1 py-2 rounded font-semibold text-sm transition-all ${inactiveClass}`;
            
            document.getElementById('container-raza').classList.add('hidden');
            document.getElementById('container-peso').classList.add('hidden');
            document.getElementById('container-subtipo-invernada').classList.remove('hidden');
            
            document.querySelectorAll('.btn-subtipo').forEach(b => b.classList.remove('bg-brand', 'text-white'));
        }
        cargarFiltrosIniciales();
    }

    // --- CARGA DE FILTROS ---
    async function cargarFiltrosIniciales() {
        try {
            const response = await fetch('/api/categorias');
            const data = await response.json();
            const selectCat = document.getElementById('categoria');
            selectCat.innerHTML = '<option value="">Seleccione Categoría</option>';
            
            if (currentMode === 'faena') {
                data.faena.forEach(cat => agregarOpcion(selectCat, cat));
            } else {
                allInvernadaCategories = data.invernada;
                data.invernada.forEach(cat => agregarOpcion(selectCat, cat));
            }
            resetDependientes();
        } catch (e) { console.error(e); }
    }

    function agregarOpcion(select, valor) {
        const opt = document.createElement('option');
        opt.value = valor; opt.textContent = valor; select.appendChild(opt);
    }

    function resetDependientes() {
        const r = document.getElementById('raza'); r.innerHTML = '<option value="">-</option>'; r.disabled = true;
        const p = document.getElementById('peso'); p.innerHTML = '<option value="">-</option>'; p.disabled = true;
    }

    // --- LÓGICA INVERNADA ---
    function filtrarCategoriasInvernada(tipo) {
        document.querySelectorAll('.btn-subtipo').forEach(b => {
            if (b.innerText.includes(tipo === 'Macho' ? 'Machos' : tipo === 'Hembra' ? 'Hembras' : 'Vientres')) {
                b.classList.add('bg-brand', 'text-white');
            } else {
                b.classList.remove('bg-brand', 'text-white');
            }
        });

        const selectCat = document.getElementById('categoria');
        selectCat.innerHTML = '<option value="">Seleccione Categoría</option>';
        
        const keywords = {
            'Macho': ['Ternero', 'Novillito', 'Holando'],
            'Hembra': ['Ternera', 'Vaquillona'],
            'Vientre': ['Vaca', 'Vientre', 'Entorar', 'Preñada', 'Cría']
        };

        const filtradas = allInvernadaCategories.filter(cat => {
            if (tipo === 'Hembra' && cat.includes('Vaquillonas') && (cat.includes('Entorar') || cat.includes('Preñadas'))) return false;
            if (tipo === 'Vientre' && cat.includes('Vaquillonas') && !(cat.includes('Entorar') || cat.includes('Preñadas'))) return false;
            return keywords[tipo].some(k => cat.includes(k));
        });

        filtradas.forEach(cat => agregarOpcion(selectCat, cat));
    }

    // --- CASCADA FAENA ---
    document.getElementById('categoria').addEventListener('change', async function() {
        const cat = this.value;
        if (!cat || currentMode === 'invernada') return;
        
        const res = await fetch(`/api/subcategorias?categoria=${encodeURIComponent(cat)}`);
        const data = await res.json();
        
        const selRaza = document.getElementById('raza');
        selRaza.innerHTML = '<option value="">Todas</option>'; selRaza.disabled = false;
        data.razas.forEach(r => agregarOpcion(selRaza, r));
        
        document.getElementById('peso').innerHTML = '<option value="">Todos</option>';
        cargarPesos(cat, null);
    });

    document.getElementById('raza').addEventListener('change', function() {
        cargarPesos(document.getElementById('categoria').value, this.value);
    });

    async function cargarPesos(cat, raza) {
        let url = `/api/subcategorias?categoria=${encodeURIComponent(cat)}`;
        if (raza) url += `&raza=${encodeURIComponent(raza)}`;
        const res = await fetch(url);
        const data = await res.json();
        const sel = document.getElementById('peso');
        sel.innerHTML = '<option value="">Todos</option>'; sel.disabled = false;
        data.pesos.forEach(p => agregarOpcion(sel, p));
    }

    // --- DOWNSAMPLING + AGREGACIÓN VOLUMEN ---
    function procesarDatos(data) {
        const modoAgrupacion = document.getElementById('agrupacion-selector').value;
        
        if (modoAgrupacion === 'diario') return data;
        
        let usarMes = false;
        let usarSemana = false;

        if (modoAgrupacion === 'auto') {
            if (data.length > 300) usarMes = true;
            else if (data.length > 60) usarSemana = true;
            else return data;
        } else {
            if (modoAgrupacion === 'mensual') usarMes = true;
            if (modoAgrupacion === 'semanal') usarSemana = true;
        }

        const agrupados = {};
        
        data.forEach(item => {
            const dateStr = currentMode === 'faena' ? item.fecha_consulta : item.fecha_consulta_fin;
            const [d, m, y] = dateStr.split('/');
            const dateObj = new Date(y, m - 1, d);
            
            let key;
            if (usarMes) {
                key = `${m}/${y}`; 
            } else if (usarSemana) {
                const day = dateObj.getDay(), diff = dateObj.getDate() - day + (day == 0 ? -6 : 1);
                const monday = new Date(dateObj.setDate(diff));
                key = monday.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            } else {
                key = dateStr;
            }

            if (!agrupados[key]) agrupados[key] = { sumPrecio: 0, sumCabezas: 0, count: 0 };
            agrupados[key].sumPrecio += item.precio_promedio_kg;
            agrupados[key].sumCabezas += (item.cabezas || 0); // Sumar volumen
            agrupados[key].count += 1;
        });

        return Object.keys(agrupados).map(key => ({
            fecha_consulta: key, 
            fecha_consulta_fin: key,
            precio_promedio_kg: agrupados[key].sumPrecio / agrupados[key].count, // Promedio
            cabezas: agrupados[key].sumCabezas // Suma Total
        }));
    }

    // --- GRÁFICO MIXTO ---
    document.getElementById('btn-actualizar').addEventListener('click', async () => {
        const start = fpStart.selectedDates[0];
        const end = fpEnd.selectedDates[0];
        if (!start || !end) { alert("Seleccione fechas"); return; }

        const cat = document.getElementById('categoria').value;
        if (!cat) { alert("Seleccione Categoría"); return; }

        const isoStart = start.toISOString().split('T')[0];
        const isoEnd = end.toISOString().split('T')[0];
        
        document.getElementById('loading-spinner').classList.remove('hidden');

        try {
            let url = currentMode === 'faena' ? '/api/faena' : '/api/invernada';
            url += `?start=${isoStart}&end=${isoEnd}&categoria=${encodeURIComponent(cat)}`;
            
            if (currentMode === 'faena') {
                const raza = document.getElementById('raza').value;
                const peso = document.getElementById('peso').value;
                if (raza) url += `&raza=${encodeURIComponent(raza)}`;
                if (peso) url += `&rango_peso=${encodeURIComponent(peso)}`;
            }

            const res = await fetch(url);
            const rawData = await res.json();

            actualizarKPIs(rawData);
            const chartData = procesarDatos(rawData);
            renderChart(chartData);

        } catch(e) { console.error(e); } 
        finally { document.getElementById('loading-spinner').classList.add('hidden'); }
    });

    function actualizarKPIs(data) {
        if (!data.length) {
            document.getElementById('kpi-maximo').innerText = '--';
            document.getElementById('kpi-cabezas').innerText = '--';
            return;
        }
        const precios = data.map(d => d.precio_promedio_kg);
        const max = Math.max(...precios);
        const cab = currentMode === 'faena' ? data.reduce((a,b)=>a+(b.cabezas||0),0) : 0;

        const fmt = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 });
        document.getElementById('kpi-maximo').innerText = fmt.format(max);
        document.getElementById('kpi-cabezas').innerText = cab > 0 ? cab.toLocaleString('es-AR') : "N/A";
    }

    function renderChart(data) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        const labels = data.map(d => currentMode === 'faena' ? d.fecha_consulta : d.fecha_consulta_fin);
        const precios = data.map(d => d.precio_promedio_kg);
        const volumen = data.map(d => d.cabezas || 0);

        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(6, 37, 65, 0.4)'); 
        gradient.addColorStop(1, 'rgba(6, 37, 65, 0.0)');

        chartInstance = new Chart(ctx, {
            data: {
                labels: labels,
                datasets: [
                    {
                        type: 'line',
                        label: 'Precio Promedio ($)',
                        data: precios,
                        borderColor: '#062541', 
                        borderWidth: 2,
                        backgroundColor: gradient,
                        fill: true,
                        pointRadius: 2,
                        pointHoverRadius: 5,
                        pointBackgroundColor: '#FFC82C',
                        yAxisID: 'y',
                        tension: 0.3,
                        order: 1 // Dibujar encima de las barras
                    },
                    {
                        type: 'bar',
                        label: 'Cabezas (Volumen)',
                        data: volumen,
                        backgroundColor: 'rgba(200, 200, 200, 0.3)', // Gris muy suave
                        barPercentage: 0.6,
                        yAxisID: 'y1',
                        order: 2 // Fondo
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: { 
                    legend: { 
                        display: true,
                        labels: { usePointStyle: true, boxWidth: 6 }
                    },
                    tooltip: {
                        backgroundColor: '#062541',
                        titleColor: '#FFC82C',
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.dataset.type === 'line') {
                                    return label + '$ ' + context.parsed.y.toLocaleString('es-AR');
                                }
                                return label + context.parsed.y.toLocaleString('es-AR');
                            }
                        }
                    },
                    zoom: {
                        pan: {
                            enabled: true,
                            mode: 'x', // Permitir arrastrar horizontalmente
                        },
                        zoom: {
                            wheel: {
                                enabled: true, // Zoom con rueda del mouse
                            },
                            pinch: {
                                enabled: true // Zoom pellizcando en móvil
                            },
                            mode: 'x', // Solo zoom horizontal (eje de tiempo)
                        }
                    }
                },
                scales: {
                    y: { 
                        type: 'linear',
                        display: true,
                        position: 'left',
                        grid: { color: '#f3f4f6' },
                        ticks: { callback: v => '$'+v }
                    },
                    y1: {
                        type: 'linear',
                        display: false, // Ocultar eje derecho para limpieza visual (o true si prefieres verlo)
                        position: 'right',
                        grid: { drawOnChartArea: false }, // No dibujar líneas horizontales para volumen
                        min: 0 
                    },
                    x: { 
                        grid: { display: false },
                        ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 8 }
                    }
                }
            }
        });
    }

    cambiarModo('faena');
</script>
{% endblock %}